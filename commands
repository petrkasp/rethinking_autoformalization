# Identity matching
export EQ_BENCHMARK=rautoformalizer-generated
mkdir -p ./result && \
cp ./data/human_equivalence/${EQ_BENCHMARK}/autoformalization.json ./result && \
.env/bin/python -m equivalence.id_match \
    --eval_set proofnet \
    --working_root ./result \
    --dataset_root ./data/


# Definitional eq
export EQ_BENCHMARK=rautoformalizer-generated
mkdir -p ./result && \
cp ./data/human_equivalence/${EQ_BENCHMARK}/autoformalization.json ./result && \
.env/bin/python -m equivalence.def_eq \
    --mathlib_root ./ \
    --eval_set proofnet \
    --working_root ./result \
    --dataset_root ./data/ \
    --repl_root .lake/packages/REPL \
    --num_concurrency 1


# Command for testing succesful installation. Runs with some default super small model.
export CUDA_VISIBLE_DEVICES=0
export VLLM_ALLOW_DEPRECATED_BEAM_SEARCH=1
export BEQ_LEVEL=normal
export EQ_BENCHMARK=rautoformalizer-generated
mkdir -p ./result && \
cp ./data/human_equivalence/${EQ_BENCHMARK}/autoformalization.json ./result && \
.env/bin/python -m equivalence.beq_${BEQ_LEVEL} \
    --port 8080 \
    --trust-remote-code \
    --enable-prefix-caching \
    --mathlib_root ./ \
    --eval_set proofnet \
    --working_root ./result \
    --dataset_root ./data/ \
    --repl_root .lake/packages/REPL \
    --try_num 16 \
    --num_concurrency 1 \
    --temperature 0.0 \


# BEq command similar to what is in README.md
export CUDA_VISIBLE_DEVICES=0
export VLLM_ALLOW_DEPRECATED_BEAM_SEARCH=1
export BEQ_LEVEL=normal
export EQ_BENCHMARK=rautoformalizer-generated
mkdir -p ./result && \
cp ./data/human_equivalence/${EQ_BENCHMARK}/autoformalization.json ./result && \
.env/bin/python -m equivalence.beq_${BEQ_LEVEL} \
    --port 8080 \
    --trust-remote-code \
    --enable-prefix-caching \
    --mathlib_root ./ \
    --eval_set proofnet \
    --working_root ./result \
    --dataset_root ./data/ \
    --repl_root .lake/packages/REPL \
    --try_num 16 \
    --num_concurrency 1 \
    --temperature 0.0 \
    --model ./internlm2-math-plus-20b

# Temperature 0.0 seems weird but is OK because we are using beam search.


# Sparse retrieval
mkdir -p ./result_bm25_f && \
.env/bin/python -m retriever.retrieve_bm25 \
    --model_path ./bm25_f \
    --save_path ./result_bm25_f \
    --eval_set proofnet


# Dense retrieval
mkdir -p ./result_dense && \
.env/bin/python -m retriever.retrieve_dr \
    --model_path ./dependency_retriever_f \
    --save_path ./result_dense \
    --eval_set proofnet

# Dense retrieval with inform, Con-NF
mkdir -p ./result_dense_inf_con && \
.env/bin/python -m retriever.retrieve_dr \
    --model_path ./dependency_retriever_f_if \
    --save_path ./result_dense_inf_con \
    --eval_set connf


## Autoformalization NO retrieval
export CUDA_VISIBLE_DEVICES=0
export VLLM_ALLOW_DEPRECATED_BEAM_SEARCH=1
mkdir -p ./result_af_nora && \
.env/bin/python -m autoformalizer.autoformalize_vllm_passk \
    --port 8080 \
    --trust-remote-code \
    --enable-prefix-caching \
    --model ./rautoformalizer_nora_internlm \
    --mathlib_root ./ \
    --eval_set proofnet \
    --working_root ./result_af_nora \
    --dataset_root ./data/ \
    --repl_root .lake/packages/REPL \
    --try_num 8 \
    --num_concurrency 1 \
    --temperature 0.0;

## Autoformalization GROUND-TRUTH retrieval
export CUDA_VISIBLE_DEVICES=0
export VLLM_ALLOW_DEPRECATED_BEAM_SEARCH=1
mkdir -p ./result_af_gtra && \
.env/bin/python -m autoformalizer.autoformalize_vllm_w_gt_passk \
    --port 8080 \
    --trust-remote-code \
    --enable-prefix-caching \
    --model ./rautoformalizer_gtra_deepseek \
    --mathlib_root ./ \
    --eval_set proofnet \
    --working_root ./result_af_gtra \
    --dataset_root ./data/ \
    --repl_root .lake/packages/REPL \
    --try_num 8 \
    --num_concurrency 1 \
    --temperature 0.0;


## Autoformalization OBSERVED retrieval
mkdir -p ./result_dense && \
.env/bin/python -m retriever.retrieve_dr \
    --model_path ./dependency_retriever_f \
    --save_path ./result_dense \
    --eval_set proofnet

export CUDA_VISIBLE_DEVICES=0
export VLLM_ALLOW_DEPRECATED_BEAM_SEARCH=1
mkdir -p ./result_af_ra && \
.env/bin/python -m autoformalizer.autoformalize_vllm_w_ra_passk \
    --port 8080 \
    --trust-remote-code \
    --enable-prefix-caching \
    --model ./rautoformalizer_ra_internlm \
    --retrieval_result_path ./result_dense \
    --mathlib_root ./ \
    --eval_set proofnet \
    --working_root ./result_af_ra \
    --dataset_root ./data/ \
    --repl_root .lake/packages/REPL \
    --try_num 8 \
    --num_concurrency 1 \
    --temperature 0.0;

